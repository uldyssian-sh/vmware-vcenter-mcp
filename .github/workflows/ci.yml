name: Enterprise CI/CD Pipeline with Security Scanning

on:
  push:
    branches: [ main, develop, release/* ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.11']
      fail-fast: false

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Syntax and import check
      run: |
        python -m py_compile src/vmware_vcenter_mcp/__init__.py
        python -c "import src.vmware_vcenter_mcp"
    
    - name: Run tests
      run: |
        pytest tests/ -v --cov=src/vmware_vcenter_mcp --cov-report=xml
    
    - name: Validate README structure
      run: |
        test -f README.md
        grep -q "VMware vCenter MCP Server" README.md
        grep -q "⭐ Star this repository if you find it helpful!" README.md
        echo "✅ README validation passed"

  security:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install security tools
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety semgrep
        pip install -r requirements.txt
    
    - name: Run Bandit security scan
      run: |
        bandit -r src/ -f json -o bandit-report.json || true
        bandit -r src/ -f txt || true
    
    - name: Run Safety dependency scan
      run: |
        safety check --json --output safety-report.json || true
        safety check || true
    
    - name: Run Semgrep security scan
      run: |
        semgrep --config=auto src/ --json --output=semgrep-report.json || true
        semgrep --config=auto src/ || true
    
    - name: Upload security reports
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json
          safety-report.json
          semgrep-report.json

  documentation:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Check documentation completeness
      run: |
        test -f README.md
        test -f LICENSE
        test -f SECURITY.md
        test -f CONTRIBUTING.md
        test -f CHANGELOG.md
        echo "✅ Documentation check passed"

  notify:
    runs-on: ubuntu-latest
    needs: [test, security, documentation]
    if: always()
    
    steps:
    - name: Notify on success
      if: needs.test.result == 'success' && needs.security.result == 'success' && needs.documentation.result == 'success'
      run: |
        echo "✅ All security checks passed successfully!"
    
    - name: Notify on failure
      if: needs.test.result == 'failure' || needs.security.result == 'failure' || needs.documentation.result == 'failure'
      run: |
        echo "⚠️ Some security checks failed - review required"
        exit 1